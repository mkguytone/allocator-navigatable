<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>37.1. 32 ビットアーキテクチャのビン</title><link rel="stylesheet" type="text/css" href="index.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Linux で C/C++ の足固め： Linux の メモリー/ファイル/mmap と C++ アロケーター" /><link rel="up" href="ch37.html" title="第37章 ビンのインデックスの計算" /><link rel="prev" href="ch37.html" title="第37章 ビンのインデックスの計算" /><link rel="next" href="ch37s02.html" title="37.2. 64 ビットアーキテクチャのビン" /><meta xmlns="" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0" /><script xmlns="" type="text/javascript" src="prettify/prettify.js"></script><link xmlns="" rel="stylesheet" type="text/css" href="prettify/skins/sons-of-obsidian.css" /><script xmlns="">
    window.addEventListener("load", function() {
      PR.prettyPrint();
	  });	
	</script><script xmlns="" type="text/javascript" src="script/head.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="ch37.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch37s02.html">次へ</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_32_ビットアーキテクチャのビン"></a>37.1. 32 ビットアーキテクチャのビン</h2></div></div></div><p>　まずは見本として largebin_index_32(sz) を見てみましょうかね。</p><pre xmlns="" class="prettyprint">1473 #define largebin_index_32(sz)                                                \
1474   (((((unsigned long) (sz)) &gt;&gt; 6) &lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;&gt; 6) :\</pre><p>　まずはソースコード内のコメントにあるように 64 バイト間隔のビンは 32 個あるとします。</p><p>　64 バイトのビンの開始サイズは 512 なので開始インデックスは 56 + (512 &gt;&gt; 6) = 56 + 8 = 64 です。</p><p>　32 ビンあるのであれば 2560 になるはずです。</p><p>　しかしながら式を信じるなら最大値は 64 * 38 = 2432 となってしまいます。</p><pre xmlns="" class="prettyprint">1475    ((((unsigned long) (sz)) &gt;&gt; 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;&gt; 9) :\</pre><p>　この場合 sz を 512 の倍数とするなら、開始点を2432 とするのは半端なので近似する倍数は 512 × 5 = 2560 となります。</p><p>　実際この近似をしないとビンの数は 30 となり必要に満たないです。</p><p>　2560 を上限値にする場合のインデックスは以下のように展開できます。</p><div class="table"><a id="idm1793"></a><p class="title"><strong>表37.1 64 バイト間隔のインデックス</strong></p><div class="table-contents"><table class="table" summary="64 バイト間隔のインデックス" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">64     </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 65     </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 66     </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 67  </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ....</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 94       </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 95</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">バイトサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">512-575</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 576-639</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 640-703</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 704-</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ....</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 2432-2495</pre></td><td style="" align="left" valign="top"><pre class="literallayout"> 2496-2559</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>　このように 64 バイト間隔と 512 バイト間隔から、バイトサイズによって算出されるインデックスがなんとなく推定できます。</p><p>　面倒なことにインデックス 95 は 1474 行ではなく 1475 行から類推されます。</p><p>　なぜかというと 1475 行の式から 2559 &gt;&gt; 9 = 4 となるので、91 + (2559 &gt;&gt; 9) = 95 が算出されるからです。</p><p>　512 バイト間隔のビンの開始サイズは 2560 なので、開始インデックスは 91 + (2560 &gt;&gt; 9) = 91 + 5 = 96 となります。</p><p>　上限値は式から 512 * 20 = 10240 となります。</p><p>　では 4096 バイト間隔のインデックス算出式はどうでしょうかね？</p><pre xmlns="" class="prettyprint">1476    ((((unsigned long) (sz)) &gt;&gt; 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;&gt; 12) :\</pre><p>　1476 行では 4096 バイト間隔のビンのインデックスを算出するのですが、10240 というのはあまり</p><p>　10240 は 4096 の倍数としては端数になってしまうため、キリの良い値は 12288 となります。</p><div class="table"><a id="idm1848"></a><p class="title"><strong>表37.2 512 バイト間隔のインデックス</strong></p><div class="table-contents"><table class="table" summary="512 バイト間隔のインデックス" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /><col class="col_10" /><col class="col_11" /><col class="col_12" /><col class="col_13" /><col class="col_14" /><col class="col_15" /><col class="col_16" /><col class="col_17" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">インデックス</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">96  </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 97  </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 98  </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 99  </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 100 </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 101 </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 102 </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 103</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 104</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 105</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 106</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 107</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 108</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">  109</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">  110 </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top"> (111)</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">バイトサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">2560-3071</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 3072-3583</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 3584-4095</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 4096-5129</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 5120-5631</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 5632-6143</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 6144-6655 </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 6656-7167</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7168-7679</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7680-8191</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">8192-8703</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">8704-9215</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">9216-9727</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">9728-10239</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">10240</pre></td><td style="" align="left" valign="top"><pre class="literallayout">(10752)</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>　式によるとインデックス 111 は飛び地となるようですね。</p><p>　10240 が上限値なので、上限値を超えた 10752 は 512 間隔のビンには適用できないサイズだからです。</p><p>　つまり (10752 &gt;&gt; 9) は 21 となりますので、条件式「 ⇐ 20 」で偽を返すため 1475 行の式は 1475 行の式の評価に移ります。</p><p>　10752 で開始インデックスを計算すると以下のように値は 112 となります。</p><pre xmlns="" class="prettyprint">　110 + (10752 &gt;&gt; 12) = 112</pre><p>　てなことでインデックス 111 で飛び地ができてるっぽいです。</p><p>　まあ飛び地といっても 100 の次がインデックス 112 になるってだけのことなんですがね。</p><p>　繰り返しになりますが 4096 バイト間隔のビンの開始サイズは 10240 なので 110 + (10240 &gt;&gt; 12) = 110 + 2 = 112 になります。</p><p>　1476 行の式により上限値は 4096 * 10 = 40960 になります。</p><p>　次は 1477 行の式です。</p><pre xmlns="" class="prettyprint">1477    ((((unsigned long) (sz)) &gt;&gt; 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;&gt; 15) :\</pre><p>　1477 行は 32768 バイトのビンのインデックスを返します。</p><p>　40960 は 32768 の倍数としては端数になるため 65536 を最大値として補正すると言いたいところですが、110 と 111 が飛び地になるのは仕方ないと諦めるしかなさそうです。</p><p>　まあ筆者が間違ってるだけかも知らんですけどね…　(´・ω・｀)</p><div class="table"><a id="idm1937"></a><p class="title"><strong>表37.3 4096 バイト間隔のインデックス</strong></p><div class="table-contents"><table class="table" summary="4096 バイト間隔のインデックス" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">インデックス</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">112</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">113</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">114</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">115</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">116</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">117</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">118</th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">119</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">バイトサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">10240-12287</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12288-16383</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">16384-20479</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">20480-24575</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">24576-28671</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">28672-32767</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">32768-36863</pre></td><td style="" align="left" valign="top"><pre class="literallayout">36864-40959</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>　これも強引に表にしちゃってます。</p><p>　まあ 1476 行の式によると 40960 を超えたら 1477 行の処理に移るのでインデックス 120 はそちらで算出できます。</p><pre xmlns="" class="prettyprint">119 + (40960 &gt;&gt; 15) = 120 + 1 = 120</pre><p>　よって、この場合の開始地点は 40960 とすれば良いでしょう。</p><p>　例のように上限値は 32768 * 4 = 131072 になります。</p><pre class="literallayout">次は 1478 行の式です。</pre><pre xmlns="" class="prettyprint">1478    ((((unsigned long) (sz)) &gt;&gt; 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;&gt; 18) :\</pre><p>　1478 行は 262144 バイトのビンのインデックスを算出します。</p><p>　ちなみに 131072 は 262144 の丁度半分になります。</p><p>　まあ 2 の倍数同士なんで、こういうこともあります…　(´・ω・｀)</p><p>　それで 1477 行の 32768 バイトのビンは以下のようになるはずです。</p><div class="table"><a id="idm1991"></a><p class="title"><strong>表37.4 32768 バイト間隔のインデックス</strong></p><div class="table-contents"><table class="table" summary="32768 バイト間隔のインデックス" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">インデックス</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">120        </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 121        </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 122         </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 123    </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top"> (124)</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">バイトサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">40960-73727</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">73728-106495</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">106496-131071</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">131072  </pre></td><td style="" align="left" valign="top"><pre class="literallayout">163840</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>　1477 行の式によると 32768 * 4 = 131072 を超えると 1478 行に処理が移ります。</p><p>　1478 行のオフセットは 124 になってるのですが 131072 は 262144 に比べると端数に過ぎません。</p><p>　てなことで 131072 をビンの開始地点とするのであれば 124 + (131072 &gt;&gt; 18) = 124 + 0 = 124 とインデックスを計算ｄけいます。</p><p>　最後に 1478 行の 262144 のビンのインデックスは以下のようになるはずです。</p><div class="table"><a id="idm2026"></a><p class="title"><strong>表37.5 262144 バイト間隔のインデックス</strong></p><div class="table-contents"><table class="table" summary="262144 バイト間隔のインデックス" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">インデックス</th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">124   </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> 125 </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top"> (126)</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">バイトサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">131073-262143</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">262144-524287 </pre></td><td style="" align="left" valign="top"><pre class="literallayout"> (524288-)</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>　1478行の式から最大値は 262144 * 2 = 524288 となります。</p><p>　あとはそれ以外のインデックスは 1 個しかないです。</p><pre xmlns="" class="prettyprint">1479    126)</pre><p>この 126 は 524288 以上になりますんで、ビンがキャッシュするチャンクのサイズはかなり巨大になってます。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch37.html">戻る</a> </td><td width="20%" align="center"><a accesskey="u" href="ch37.html">上に戻る</a></td><td width="40%" align="right"> <a accesskey="n" href="ch37s02.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div><wrapper xmlns=""><p>Copyright 2018-2019, by Masaki Komatsu</p>


</wrapper></body></html>