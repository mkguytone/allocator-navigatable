<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>37.2. 64 ビットアーキテクチャのビン</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Linux で C/C++ の足固め： Linux の メモリー/ファイル/mmap と C++ アロケーター" /><link rel="up" href="ch37.html" title="第37章 ビンのインデックスの計算" /><link rel="prev" href="ch37s01.html" title="37.1. 32 ビットアーキテクチャのビン" /><link rel="next" href="ch38.html" title="第38章 ビン・インデックスのまとめ" /><script xmlns="" type="text/javascript" src="prettify/prettify.js"></script><link xmlns="" rel="stylesheet" type="text/css" href="prettify/skins/sons-of-obsidian.css" /><script xmlns="">
    window.addEventListener("load", function() {
      PR.prettyPrint();
	  });	
	</script><script xmlns="" type="text/javascript" src="script/head.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="ch37s01.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch38.html">次へ</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_64_ビットアーキテクチャのビン"></a>37.2. 64 ビットアーキテクチャのビン</h2></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">注記</h3><p>largebin_index_32(sz) と largebin_index_64(sz) マクロは 64 バイト間隔のビンの処理を除くと同じコードになっています。したがってこの項目は 32 ビットの説明をスキップした方が読めば良いでしょう。</p></div><p>　筆者の検証環境では 16 バイトアラインメント、64 ビットアーキテクチャなので largebin_index_64(sz) が該当します。</p><pre xmlns="" class="prettyprint">1492 #define largebin_index_64(sz)                                                \
1493   (((((unsigned long) (sz)) &gt;&gt; 6) &lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;&gt; 6) :\</pre><p>　まずは 1493 行ですね…</p><p>　smallbin_index(sz) によると 64 ビットアーキテクチャ、 16 バイトアラインメントは 1023 が上限なので、 Large bin は 1024 バイトが開始点になります。</p><p>　つまり式を組み合わせると開始インデックスは 48 + (1024 &gt;&gt; 6) = 48 + 16 = 64 になります。</p><p>　64 バイト間隔のビンの上限値は 64 * 48 = 3072 となります。</p><p>　まあ以下のようになるでしょうね。</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">64  </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 65 </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 66 </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">   </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 95 </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> (96)</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">ビンサイズ  </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1024-1087</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1088-1151</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1152-1215</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">...</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3008-3071</pre></td><td style="" align="left" valign="top"><pre class="literallayout"> (3072)</pre></td></tr></tbody></table></div><p>　64 バイト間隔のビンは 32 あるという想定だとインデックス 96 は 512 バイト間隔のビンと重なりそうな箇所ですが、1494 行でどのように扱われてるかチェックしましょう。</p><pre xmlns="" class="prettyprint">1494    ((((unsigned long) (sz)) &gt;&gt; 9) &lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;&gt; 9) :\</pre><p>　512 バイトのビンの開始インデックスは 91 + (3073 &gt;&gt; 9) = 91 + 6 = 97 となります。</p><p>　この解釈正しいんですかね…</p><p>　(´・ω・｀)</p><p>　何故迷うかというと 3072 のインデックスは 96 、次は 3073 のインデックスが 97 になるだけなので、64 バイトでなく 512 バイトのサイズに入れても問題ないですから…（喉からから）</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">(96)   </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">97  </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 98 </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 99 </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">   </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 110                     </pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 111   </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> (112)</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">ビンサイズ  </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">(3072) </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3073-3583</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3584-4095</pre></td><td style="" align="left" valign="top"><pre class="literallayout">4096-4607</pre></td></tr></tbody></table></div><p>　512 バイト間隔のビンの開始点は 3073 なので 91 + (3072 &gt;&gt; 9) = 91 + 6 = 97 です。</p><p>　つまり 96 は実質的には飛び地になるようです。</p><p>　ちなみに上限値は 512 * 20 = 10240 となりますが、これだと 512 バイト間隔のビンの最後のインデックスは 111 となるべきのような気がします。</p><p>　仕様だと 16 ビンあるはずでし、やはり 96 , …. , 111 が正しい範囲っぽそうです。</p><p>　問題はインデックス 112 がどうなるかなので、次の条件式を見てみましょう。</p><pre xmlns="" class="prettyprint">1495    ((((unsigned long) (sz)) &gt;&gt; 12) &lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;&gt; 12) :\</pre><p>　これによると 10241-10752 は 4096 の倍数にならない値は端数となります。</p><p>　110 + (10752 &gt;&gt; 12) = 110 + 2 = 112</p><p>　次のインデックスは 4096 * 2 = 12282 になるまで動きがありません。</p><p>　110 + (12288 &gt;&gt; 12) = 110 + 3 = 113</p><p>　4096 バイト間隔のビンの開始は 10241 からなので 110 + (10241 &gt;&gt; 12) = 110 + 2 = 112 がインデックスになります。</p><p>　さらに上限値は 4096 * 10 = 40960 となります。</p><p>　そうすると 4096 バイト間隔のインデックス範囲は 112 , …, 119 または 113 , …, 120 になるはずです。</p><p>　まあでも仕様に忠実とするなら 112, 113, …, 119 のほうが良さそうです。</p><p>　たぶん以下のような感じになりますね。</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /><col class="col_10" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">112       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 113        </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">  114       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">  115       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">  116       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">  117       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">  118       </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 119        </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> (120)</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">ビンの範囲  </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">10241-12287</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 12288-16383</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 16384-20479</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 20480-24575</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 24576-28671</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 28672-32767</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 32768-36863</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 36864-40959</pre></td><td style="" align="left" valign="top"><pre class="literallayout"> (40960)</pre></td></tr></tbody></table></div><p>　念の為にインデックス 120 がどうなるのか次のビン（ 32768 バイト間隔）の条件式でチェックしてみましょう。</p><pre xmlns="" class="prettyprint">1496    ((((unsigned long) (sz)) &gt;&gt; 15) &lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;&gt; 15) :\</pre><p>　32768 バイト間隔のビンの開始インデックスは 119 + (40960 &gt;&gt; 15) = 119 + 1 = 120 と計算できます。</p><p>　さらに上限値は 23768 * 4 = 131072 になります。</p><p>　この情報から推測すると以下のようになるはずです。</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">120         </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">121           </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">122            </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">123</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">ビンのサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">40960-73727 </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 73728-106495 </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 106496-131071 </pre></td><td style="" align="left" valign="top"><pre class="literallayout"> 131072</pre></td></tr></tbody></table></div><p>　てことで 120, …, 123 が 32768 バイト間隔のインデックス範囲となるはずです。</p><p>　もちろん計算が間違いでなければですが…　(´・ω・｀)</p><p>　では 262144 バイト間隔のビンの条件式も見てみましょう。</p><pre xmlns="" class="prettyprint">1497    ((((unsigned long) (sz)) &gt;&gt; 18) &lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;&gt; 18) :\
1498    126)</pre><p>　262144 バイト間隔のビンの開始インデックスは 124 + ( 131072 &gt;&gt; 18 ) = 124 + 0 = 124 となりますね。</p><p>　類推されるビンのインデックスは以下のような配置になるかと思います。</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">124           </pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">125            </pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> (126)</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">ビンのサイズ</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">131072-262143 </pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 262144-524287 </pre></td><td style="" align="left" valign="top"><pre class="literallayout"> 524288-</pre></td></tr></tbody></table></div><p>　インデックス 126 は大きいのは何でもありって感じのビンですね。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch37s01.html">戻る</a> </td><td width="20%" align="center"><a accesskey="u" href="ch37.html">上に戻る</a></td><td width="40%" align="right"> <a accesskey="n" href="ch38.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div><p xmlns="">Copyright 2018-2019, by Masaki Komatsu</p></body></html>